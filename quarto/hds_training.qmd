---
title: "HDS training: Reporting tools"
format:
  revealjs: 
    theme: [simple, custom_1.scss]
    incremental: true   
    slide-number: true
    chalkboard: true
    preview-links: auto
    margin: 0.07
    code-link: true
    code-line-numbers: false
    height: 900
    width: 1600
execute:
  echo: true
  eval: true
editor: visual
---

## Content

-   Simple manipulations of the `summarised_result` object.
-   **Quarto** to create reports.
-   **OmopViewer** to create shiny apps.

```{r, echo=FALSE}
options(width=125)
```

## The `summarised_result` object

The `summarised_result` object is defined with 13 columns:

```{r}
omopgenerics::resultColumns()
```

```{r}
visOmopResults::mockSummarisedResult() |>
  dplyr::glimpse()
```

## Settings attribute

```{r}
result <- visOmopResults::mockSummarisedResult()
omopgenerics::settings(result) |>
  dplyr::glimpse()
```

## Explore the `summarised_result` object

The best way to explore the `summarised_result` object is filtering to the result_type of interest and then using the `tidy()` function:

```{r}
result |>
  omopgenerics::filterSettings(result_type == "mock_summarised_result") |>
  broom::tidy() # also reexported in omopgenerics/visOmopResults and many of the analytics packages
```

## Filter the `summarised_result` object

-   `dplyr::filter()` it is the normal filter function you specify a column and then you can filter

. . .

```{r}
result |>
  dplyr::filter(variable_level == "Amoxiciline" & strata_name == "overall")
```

## Filter the `summarised_result` object

-   `omopgenerics::filterSettings()` you can filter using the settings.

. . .

```{r}
omopgenerics::settings(result)
result |>
  omopgenerics::filterSettings(
    result_type == "mock_summarised_result" & 
      package_name == "visOmopResults"
  )
```

## Filter the `summarised_result` object

-   `omopgenerics::filterGroup/Strata/Additional()` you can filter using the 'tidy' version of group, strata or additional.

. . .

```{r}
result |>
  omopgenerics::filterStrata(sex == "Female")
```

## Tidy the `summarised_result`

-   `omopgenerics::addSettings()` to add columns of the settings.
-   `omopgenerics::splitGroup/Strata/Additional/All` to split a name-level pair into independent columns.
-   `omopgenerics::pivotEstimates()` to pivot the estimates giving the correct type.

## Import/Export the `summarised_result`

Although we export and import the `summarised_result` from csv files it is important that we import and export them with the appropriate functions. This is important to make sure settings are exported and imported correctly.

-   `importSummarisedResult()` To import a `summarised_result` object from a csv file.
-   `exportSummarisedResult()` To create a csv file from a `summarised_result` object. Note that by default counts will be suppressed with `minCellCount = 5`.

. . .

! Note that `readr::write_csv()` and `readr::read_csv` will not export/import settings therefore results will be incomplete.

## Cheatsheet

If there is time add a cheatsheet here and give it to everyone

## Your turn

Prepare your session:

1)  Create a project (top right of Rstudio + new project)

2)  Install last version of `omopgenerics`

```{r, eval=FALSE}
install.packages("omopgenerics")
```

3)  Open empty file: `tidy_result.R`

4)  Create empty folder `data`

```{r, eval=FALSE}
dir.create(here::here("data"))
```

5)  Download the results that we are going to work with

```{r, eval=FALSE}
download.file(
  url = "https://raw.githubusercontent.com/darwin-eu-dev/DrugUtilisation/refs/heads/main/extras/mock_drug_strength.csv?token=GHSAT0AAAAAACVBWZS75DTO24L6FNT6CYDKZ42QESA",
  destfile = here::here("data", "results.csv")
)
```

## Your turn

Exercise: *(5 minutes)*

-   Import the results.
-   How many results types are included?
-   Which are the version of the packages used?
-   Show the tidy version of one of the *result_type* that you want to analyse

## Solution

```{r, eval=FALSE}
result <- omopgenerics::importSummarisedResult(here::here("data", "results.csv"))
result |>
  omopgenerics::settings() |>
  dplyr::pull("result_type") |>
  unique()
result |>
  omopgenerics::settings() |>
  dplyr::select(package_name, package_version) |>
  dplyr::distinct()
result |>
  omopgenerics::filterSettings(result_type == "...") |>
  omopgenerics::tidy()
```

## Quarto: Why Another Tool?

. . .

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

-   **We use Shiny** for interactive analysis.
-   But what about:
    -   Static reports for regulatory submissions?
    -   Summaries with tables and figures for publications?
    -   Easy export to Word/PDF without manual copy-pasting?
-   **Quarto** helps us generate structured, automated, and reproducible reports. 

## Quarto vs. Shiny: Different Purposes

| Feature             | **Shiny (Apps)**          | **Quarto (Reports)**              |
|--------------------|----------------------|------------------------------|
| **User Need**       | Interactive dashboards    | Static reports with analysis      |
| **Reproducibility** | Reacts to user inputs     | Fixed, version-controlled outputs |
| **Output Format**   | Web-based UI              | Word, PDF, HTML, PowerPoint       |
| **Best For**        | Exploratory data analysis | Structured study reports          |

. . .

ðŸ’¡ **We need both**:

-   **Shiny** for exploring data.
-   **Quarto** for final reporting.

## Write simple quarto code

Create my first quarto document:

*Blank file* -> *Quarto Doc...* -> *my_first_quarto.qmd*

. . .

Use the **Render** button to generate the html document. 

![](images/render.png)

## Write simple quarto code

Let's add some content to the quarto document:

```{yaml}
---
title: "My quarto document"
format: html
editor: visual
---
```

## Write simple quarto code

![](images/only_title.png)

## Write simple quarto code

Add some text:

. . .

```{yaml}
---
title: "My quarto document"
format: html
editor: visual
---
  
We can add some text here
```

## Write simple quarto code

![](images/some_text.png)

## Titles

We can add titles using '\#', more symbols lower level:

``` markdown
## Title
### Subtitle
#### Subsubtitle
##### Subsubsubtitle
We can add some text here
```

## Titles

![](images/titles.png)

## Links

Links can be added in two different ways:

``` markdown
<https://www.ndorms.ox.ac.uk>
[Label](https://quarto.org)
```

## Links

![](images/links.png)

## Images

You can easily add images like:

``` markdown
![](relative path to image)
![](myfigure.png)
![](folder/myfigure.png)
```

## Code

The main reason to use quarto is that we can embed code into quarto!

To add code we can use:

``` markdown
` ``{r}
ggplot2::ggplot(ggplot2::midwest, ggplot2::aes(x=area, y=poptotal)) + 
  ggplot2::geom_point(ggplot2::aes(col=state, size=popdensity)) + 
  ggplot2::geom_smooth(method="loess", se=F) + 
  ggplot2::xlim(c(0, 0.1)) + 
  ggplot2::ylim(c(0, 500000)) + 
  ggplot2::labs(
    subtitle="Area Vs Population", 
    y="Population", 
    x="Area", 
    title="Scatterplot", 
    caption = "Source: midwest"
  )
` ``
```
. . .

You can add the code chunk with the following button:

![](images/code.png)

## Code

![](images/plots.png)

## Code

::: {.callout-tip}
You can hide, messages, warning, output using the following options:

- message=**TRUE**/FALSE
- warning=**TRUE**/FALSE
- echo=**TRUE**/FALSE
- eval=**TRUE**/FALSE
:::

. . .

``` markdown
` ``{{r, warning=FALSE, message=FALSE, echo=FALSE}}
ggplot2::ggplot(ggplot2::midwest, ggplot2::aes(x=area, y=poptotal)) + 
  ggplot2::geom_point(ggplot2::aes(col=state, size=popdensity)) + 
  ggplot2::geom_smooth(method="loess", se=F) + 
  ggplot2::xlim(c(0, 0.1)) + 
  ggplot2::ylim(c(0, 500000)) + 
  ggplot2::labs(subtitle="Area Vs Population", 
       y="Population", 
       x="Area", 
       title="Scatterplot", 
       caption = "Source: midwest")
` ``
```

## Code

![](images/plots_no_print.png)

## Code

You can also include simple code in the middle of text:

![](images/code_inline.png)

. . .

```{r, echo=FALSE}
n <- 623874
p <- 532672/n
```

We have `r sprintf('%i', n)` individuals in my report from those `r sprintf('%.1f', 100*p)`% had the condition of interest.

## Output format

By default we've used html as output, but several outputs can be used:

- html; [format options](https://quarto.org/docs/reference/formats/html.html)
- docx; [format options](https://quarto.org/docs/reference/formats/docx.html)
- pdf; [format options](https://quarto.org/docs/reference/formats/pdf.html)
- revealjs; [format options](https://quarto.org/docs/reference/formats/presentations/revealjs.html)

See all output formats and options: <https://quarto.org/docs/reference/>

## Your turn

*5 minutes*

Create a quarto file that:

- Generates a 'Microsoft Word' document

- Add a title

- Subtitle (##)

- A link

- Some code

```{r, eval=FALSE}
# example
ggplot2::ggplot(cars, ggplot2::aes(x = speed, y = dist)) +
  ggplot2::geom_point()
```

## Your turn

``` markdown
---
title: "ggplot2"
format: docx
editor: visual
---

## Plotting with R

ggplot2 is a very powerful R package that allows us to create plots in R. The ggplot2 package is available from [cran](https://cran.r-project.org). There are very nice tutorials in a the [ggplot2 website](https://ggplot2.tidyverse.org).

## Example

Here some simple code that creates an scatter plot:

` ``{{r}}
ggplot2::ggplot(cars, ggplot2::aes(x = speed, y = dist)) +
  ggplot2::geom_point()
` ``

```

## Your turn

![](images/word_exercise1.png)

## Use the omopverse tools in reports

With the help of `visOmopResults` package, we can use **table and plot functions** to directly output results in different formats. Examples:

::: {style="max-height: 500px; overflow-x: auto; font-size: 0.8em;"}
| **Package** | **Result Function** | **result_type** | **Table Function** | **Plot Function** |
|---------------|---------------|---------------|---------------|---------------|
| `CohortCharacteristics` | `summariseCharacteristics` | summarise_characteristics  | `tableCharacteristics` | `plotCharacteristics` |
| `IncidencePrevalence` | `estimateIncidence` | incidence | `tableIncidence` | `plotIncidence` |
| `DrugUtilisation` | `summariseDrugUtilisation` | summarise_drug_utilisation | `tableDrugUtilisation` | `plotDrugUtilisation` |
:::

. . .

ðŸ’¡ **Key Points:**

-   **Each result function** computes the summary/statistics.

-   **Table functions** generate structured tables.

-   **Plot functions** provide visual representations.

-   All these functions are backed by `visOmopResults` for consistency.

## Table Output Options

ðŸ’¡ **Which one to use?**

::: {style="max-height: 500px; overflow-y: auto; font-size: 0.8em;"}
| **Type**      | **Package Used** | **Best For**            | **Key Features**                                                     |
|----------------|----------------|----------------|-----------------------|
| `"gt"`        | `gt`             | HTML / PDF reports      | \- Publication-quality tables <br>- Styling, footnotes, citations    |
| `"flextable"` | `flextable`      | Word / PowerPoint       | \- Best for MS Word & PPT <br>- More control over formatting         |
| `"tibble"`    | `tibble`         | Data wrangling in R     | \- Prints neatly in console <br>- Not for final reports              |
| `"datatable"` | `DT`             | Interactive web reports | \- JavaScript-powered tables <br>- Search, filter, and sort features |
:::

## Create a simple table 

```{r}
results <- omopgenerics::importSummarisedResult(here::here("data"))
CohortCharacteristics::tableCharacteristics(result)
```

## Create a simple table

```{r}
CohortCharacteristics::tableCharacteristics(result, type = "flextable")
```

## Plot Output Options

ðŸ’¡ **Which one to use?**

- `ggplot2` for everything (mainly static reports, but also useful for shiny apps).
- `plotly` mainly for interactive output (shiny apps).

## Create a simple plot

```{r}
DrugUtilisation::plotProportionOfPatientsCovered(result, type = "flextable")
```

## OmopViewer

. . .

## Thanks

How can we better help?
